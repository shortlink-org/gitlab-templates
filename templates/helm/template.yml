spec:
  inputs:
    stage:
      default: action
      description: "Define the stage this job will run in"
---

.job_template_helm:
  stage: $[[ inputs.stage ]]
  image:
    name: alpine/helm:4.1
    entrypoint: [""]
  variables:
    HELM_EXPERIMENTAL_OCI: 1
    SOPS_VERSION: v3.12.1
    HELM_SECRETS_VERSION: "4.7.4"
    GNUPGHOME: /root/.gnupg

  before_script:
    - apk add --no-cache bash curl git gnupg ca-certificates

    # Ensure GNUPG home exists with correct perms (Helm verifier expects this path)
    - mkdir -p "$GNUPGHOME"
    - chmod 700 "$GNUPGHOME"

    # Force legacy keyring file that Helm verification expects
    - touch "$GNUPGHOME/pubring.gpg"
    - chmod 600 "$GNUPGHOME/pubring.gpg"

    # Import helm-secrets maintainer public key into the legacy keyring
    - |
      curl -fsSL https://github.com/jkroepke.gpg \
        | gpg --batch --no-default-keyring --keyring "$GNUPGHOME/pubring.gpg" --import

    # (Optional) Show imported public key
    - gpg --batch --no-default-keyring --keyring "$GNUPGHOME/pubring.gpg" --list-keys --fingerprint

    # Install helm-secrets plugins with verification enabled
    - |
      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-${HELM_SECRETS_VERSION}.tgz" \
        --verify

      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-getter-${HELM_SECRETS_VERSION}.tgz" \
        --verify

      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-post-renderer-${HELM_SECRETS_VERSION}.tgz" \
        --verify

    # Install sops
    - |
      curl -fsSL \
        "https://github.com/mozilla/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" \
        -o /usr/local/bin/sops
      chmod +x /usr/local/bin/sops

    # Import your private GPG key used by sops (GPG_TOKEN is a multiline text variable)
    - echo "$GPG_TOKEN" | gpg --batch --import

  retry: 1
