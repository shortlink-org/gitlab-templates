spec:
  inputs:
    stage:
      default: action
      description: "Define the stage this job will run in"
---

.job_template_helm:
  stage: $[[ inputs.stage ]]
  image:
    name: alpine/helm:4.1
    entrypoint: [""]
  variables:
    HELM_EXPERIMENTAL_OCI: 1

    # sops
    SOPS_VERSION: v3.12.1

    # helm-secrets (Helm 4 installs from release .tgz archives)
    HELM_SECRETS_VERSION: "4.7.4"

  before_script:
    - apk add --no-cache bash curl git gnupg ca-certificates

    # Import helm-secrets maintainer public PGP key (for Helm 4 plugin verification)
    - |
      curl -fsSL https://github.com/jkroepke.gpg | gpg --batch --import

    # (Optional) Show imported public key info
    - gpg --list-keys --fingerprint

    # Install helm-secrets plugins (Helm 4 split plugins) with verification enabled
    - |
      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-${HELM_SECRETS_VERSION}.tgz" \
        --verify

      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-getter-${HELM_SECRETS_VERSION}.tgz" \
        --verify

      helm plugin install \
        "https://github.com/jkroepke/helm-secrets/releases/download/v${HELM_SECRETS_VERSION}/secrets-post-renderer-${HELM_SECRETS_VERSION}.tgz" \
        --verify

    # Install sops
    - |
      curl -fsSL \
        "https://github.com/mozilla/sops/releases/download/${SOPS_VERSION}/sops-${SOPS_VERSION}.linux.amd64" \
        -o /usr/local/bin/sops
      chmod +x /usr/local/bin/sops

    # Import your private GPG key used by sops (GPG_TOKEN is a multiline text variable)
    - |
      echo "$GPG_TOKEN" | gpg --batch --import

    # (Optional) Verify the private key is present
    - gpg --list-secret-keys --keyid-format LONG

  retry: 1
